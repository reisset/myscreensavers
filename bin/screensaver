#!/bin/bash
# screensaver - Display animated ASCII art with cycling TerminalTextEffects
#
# Usage: ./bin/screensaver [ascii_file]
# Press Ctrl+C to exit

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
ASCII_ART="${1:-$SCRIPT_DIR/config/ascii_art/ascii-text-art.txt}"
EFFECT_DURATION=30  # seconds per effect
PAUSE_BETWEEN=3     # seconds between effects

# Curated effects that look good as screensavers
EFFECTS=(
    matrix
    rain
    decrypt
    beams
    fireworks
    waves
    pour
    swarm
    rings
    bubbles
    spray
    slide
    scattered
)

# Check dependencies
if ! command -v tte &>/dev/null; then
    echo "Error: 'tte' (terminaltexteffects) not found."
    echo "Install with: pip install terminaltexteffects"
    exit 1
fi

if [[ ! -f "$ASCII_ART" ]]; then
    echo "Error: ASCII art file not found: $ASCII_ART"
    exit 1
fi

# Track background process for cleanup
TTE_PID=""

# Cleanup function - kills tte immediately and restores cursor
cleanup() {
    [[ -n "$TTE_PID" ]] && kill "$TTE_PID" 2>/dev/null
    tput cnorm 2>/dev/null || true
    clear
    exit 0
}
trap cleanup EXIT SIGTERM SIGINT

# Hide cursor and clear screen once at start
tput civis 2>/dev/null || true
clear

# Shuffle array function (Fisher-Yates)
shuffle_effects() {
    local -a arr=("$@")
    local i j temp n=${#arr[@]}
    for ((i = n - 1; i > 0; i--)); do
        j=$((RANDOM % (i + 1)))
        temp=${arr[i]}
        arr[i]=${arr[j]}
        arr[j]=$temp
    done
    echo "${arr[@]}"
}

# Track if this is the first effect (to establish canvas position)
FIRST_RUN=true

# Cycle through effects forever, shuffled each round
while true; do
    # Shuffle effects for this cycle (see all 13 before any repeat)
    read -ra SHUFFLED <<< "$(shuffle_effects "${EFFECTS[@]}")"

    for EFFECT in "${SHUFFLED[@]}"; do
        if [[ "$FIRST_RUN" == true ]]; then
            # First effect: establish canvas position (no --reuse-canvas)
            timeout "$EFFECT_DURATION" tte \
                --canvas-width 0 \
                --canvas-height 0 \
                --anchor-canvas c \
                --anchor-text c \
                --no-eol \
                --no-restore-cursor \
                "$EFFECT" < "$ASCII_ART" 2>/dev/null &
            FIRST_RUN=false
        else
            # Subsequent effects: reuse canvas for seamless in-place transition
            timeout "$EFFECT_DURATION" tte \
                --canvas-width 0 \
                --canvas-height 0 \
                --anchor-canvas c \
                --anchor-text c \
                --reuse-canvas \
                --no-eol \
                --no-restore-cursor \
                "$EFFECT" < "$ASCII_ART" 2>/dev/null &
        fi
        TTE_PID=$!

        # Wait for tte to finish (or be killed by signal)
        wait "$TTE_PID" 2>/dev/null || true
        TTE_PID=""

        # Brief pause between effects
        sleep "$PAUSE_BETWEEN"
    done
done
