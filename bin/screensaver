#!/bin/bash
# screensaver - Display animated ASCII art with cycling TerminalTextEffects
#
# Usage: ./bin/screensaver [ascii_file]
# Press Ctrl+C to exit

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
ART_DIR="$SCRIPT_DIR/config/ascii_art"

# Default to the passed file, OR null to indicate directory rotation
MANUAL_ART="${1:-}"

SAFETY_TIMEOUT=60   # Global safety cap (in case an effect hangs)
PAUSE_BETWEEN=2     # seconds between effects

# Curated effects that look good as screensavers
# NOTE: Infinite effects (like swarm) are excluded.
EFFECTS=(
    beams
    binarypath
    blackhole
    bubbles
    burn
    crumble
    decrypt
    fireworks
    laseretch
    matrix
    orbittingvolley
    pour
    print
    rain
    scattered
    slide
    spray
    synthgrid
    thunderstorm
    vhstape
    waves
    wipe
)

# Check dependencies
if ! command -v tte &>/dev/null; then
    echo "Error: 'tte' (terminaltexteffects) not found."
    echo "Install with: pip install terminaltexteffects"
    exit 1
fi

if [[ -n "$MANUAL_ART" && ! -f "$MANUAL_ART" ]]; then
    echo "Error: ASCII art file not found: $MANUAL_ART"
    exit 1
fi

# Track background process for cleanup
TTE_PID=""

# Cleanup function - kills tte immediately and restores cursor
cleanup() {
    [[ -n "$TTE_PID" ]] && kill "$TTE_PID" 2>/dev/null
    tput cnorm 2>/dev/null || true
    clear
    exit 0
}
trap cleanup EXIT SIGTERM SIGINT

# Handle terminal resize
handle_resize() {
    TERM_COLS=$(tput cols 2>/dev/null || echo "$TERM_COLS")
    TERM_ROWS=$(tput lines 2>/dev/null || echo "$TERM_ROWS")
    [[ -n "$TTE_PID" ]] && kill "$TTE_PID" 2>/dev/null
    FIRST_RUN=true  # Re-establish canvas with new dimensions
}
trap handle_resize SIGWINCH

# Hide cursor and clear screen once at start
tput civis 2>/dev/null || true
clear

# Wait for terminal to reach stable dimensions (handles fullscreen transition)
wait_for_stable_dimensions() {
    local prev_cols=0 prev_rows=0 stable_count=0 attempt=0
    local max_attempts=20  # Max 2 seconds (20 * 0.1s)

    while [[ $stable_count -lt 3 && $attempt -lt $max_attempts ]]; do
        TERM_COLS=$(tput cols 2>/dev/null || echo 80)
        TERM_ROWS=$(tput lines 2>/dev/null || echo 24)

        if [[ "$TERM_COLS" == "$prev_cols" && "$TERM_ROWS" == "$prev_rows" ]]; then
            ((stable_count++))
        else
            stable_count=0
            prev_cols=$TERM_COLS
            prev_rows=$TERM_ROWS
        fi
        ((attempt++))
        sleep 0.1
    done

    # Sanity check for fullscreen (should be >100 cols on modern displays)
    if [[ $TERM_COLS -lt 100 || $TERM_ROWS -lt 20 ]]; then
        sleep 0.5
        TERM_COLS=$(tput cols 2>/dev/null || echo 80)
        TERM_ROWS=$(tput lines 2>/dev/null || echo 24)
    fi
}

# Shuffle array function (Fisher-Yates)
shuffle_effects() {
    local -a arr=("$@")
    local i j temp n=${#arr[@]}
    for ((i = n - 1; i > 0; i--)); do
        j=$((RANDOM % (i + 1)))
        temp=${arr[i]}
        arr[i]=${arr[j]}
        arr[j]=$temp
    done
    echo "${arr[@]}"
}

# Initialize terminal dimensions
wait_for_stable_dimensions

# Track if this is the first effect (to establish canvas position)
FIRST_RUN=true

# Cycle through effects forever, shuffled each round
while true; do
    # Shuffle effects for this cycle (see all available before any repeat)
    read -ra SHUFFLED <<< "$(shuffle_effects "${EFFECTS[@]}")"

    for EFFECT in "${SHUFFLED[@]}"; do
        # Select Art: Use manual file if set, otherwise pick random .txt from ART_DIR
        if [[ -n "$MANUAL_ART" ]]; then
            CURRENT_ART="$MANUAL_ART"
        else
            # Find a random .txt file, ensuring it's not the same as the previous one
            # 2>/dev/null suppresses errors if dir is empty.
            # Loop max 5 times to find a different file (prevents infinite loop if only 1 file exists)
            for ((i=0; i<5; i++)); do
                NEXT_ART=$(find "$ART_DIR" -name "*.txt" 2>/dev/null | shuf -n 1)
                [[ "$NEXT_ART" != "$PREVIOUS_ART" ]] && break
            done
            
            # Fallback if find failed or only 1 file exists
            CURRENT_ART="${NEXT_ART:-$ART_DIR/ascii-text-art.txt}"
            PREVIOUS_ART="$CURRENT_ART"
        fi

        if [[ "$FIRST_RUN" == true ]]; then
            # First effect: establish canvas position (no --reuse-canvas)
            timeout "$SAFETY_TIMEOUT" tte \
                --canvas-width "$TERM_COLS" \
                --canvas-height "$TERM_ROWS" \
                --anchor-canvas c \
                --anchor-text c \
                --no-eol \
                --no-restore-cursor \
                "$EFFECT" < "$CURRENT_ART" 2>/dev/null &
            FIRST_RUN=false
        else
            # Subsequent effects: reuse canvas for seamless in-place transition
            timeout "$SAFETY_TIMEOUT" tte \
                --canvas-width "$TERM_COLS" \
                --canvas-height "$TERM_ROWS" \
                --anchor-canvas c \
                --anchor-text c \
                --reuse-canvas \
                --no-eol \
                --no-restore-cursor \
                "$EFFECT" < "$CURRENT_ART" 2>/dev/null &
        fi
        TTE_PID=$!

        # Wait for tte to finish (or be killed by signal)
        wait "$TTE_PID" 2>/dev/null || true
        TTE_PID=""

        # Brief pause between effects
        sleep "$PAUSE_BETWEEN"
    done
done
