#!/bin/bash
# screensaver - Display animated ASCII art with cycling TerminalTextEffects
#
# Usage: ./bin/screensaver [ascii_file]
# Press Ctrl+C to exit

set -e

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
ASCII_ART="${1:-$SCRIPT_DIR/config/ascii_art/ascii-text-art.txt}"
DEFAULT_EFFECT_DURATION=30  # fallback if effect not in EFFECT_DURATIONS
PAUSE_BETWEEN=3     # seconds between effects

# Individual effect durations (seconds) - optimized based on natural animation cycles
declare -A EFFECT_DURATIONS=(
    # Very short effects - need generous buffer to be visible
    [slide]=10        # Natural: 3s  | Buffer: +7s
    [scattered]=10    # Natural: 4s  | Buffer: +6s

    # Short-to-medium effects
    [spray]=15        # Natural: 8s  | Buffer: +7s
    [pour]=15         # Natural: 9s  | Buffer: +6s
    [waves]=15        # Natural: 10s | Buffer: +5s
    [rain]=15         # Estimated (no test data)

    # Medium-to-long effects
    [beams]=20        # Natural: 15s | Buffer: +5s
    [decrypt]=25      # Natural: 17s | Buffer: +8s
    [bubbles]=25      # Natural: 18s | Buffer: +7s
    [thunderstorm]=25 # Natural: 18s | Buffer: +7s (NEW - replaces rings)

    # Long effects - need extra time to feel complete
    [fireworks]=30    # Natural: 23s | Buffer: +7s
    [matrix]=40       # Natural: 22s | Buffer: +18s (user reports needs more time)
)

# Curated effects that look good as screensavers
EFFECTS=(
    matrix
    rain
    decrypt
    beams
    fireworks
    waves
    pour
    # swarm      # Removed: infinite effect causes ~5s hangs
    thunderstorm # Replaces rings (18s natural duration, tested and working)
    bubbles
    spray
    slide
    scattered
)

# Check dependencies
if ! command -v tte &>/dev/null; then
    echo "Error: 'tte' (terminaltexteffects) not found."
    echo "Install with: pip install terminaltexteffects"
    exit 1
fi

if [[ ! -f "$ASCII_ART" ]]; then
    echo "Error: ASCII art file not found: $ASCII_ART"
    exit 1
fi

# Track background process for cleanup
TTE_PID=""

# Cleanup function - kills tte immediately and restores cursor
cleanup() {
    [[ -n "$TTE_PID" ]] && kill "$TTE_PID" 2>/dev/null
    tput cnorm 2>/dev/null || true
    clear
    exit 0
}
trap cleanup EXIT SIGTERM SIGINT

# Hide cursor and clear screen once at start
tput civis 2>/dev/null || true
clear

# Shuffle array function (Fisher-Yates)
shuffle_effects() {
    local -a arr=("$@")
    local i j temp n=${#arr[@]}
    for ((i = n - 1; i > 0; i--)); do
        j=$((RANDOM % (i + 1)))
        temp=${arr[i]}
        arr[i]=${arr[j]}
        arr[j]=$temp
    done
    echo "${arr[@]}"
}

# Track if this is the first effect (to establish canvas position)
FIRST_RUN=true

# Cycle through effects forever, shuffled each round
while true; do
    # Shuffle effects for this cycle (see all 12 before any repeat)
    read -ra SHUFFLED <<< "$(shuffle_effects "${EFFECTS[@]}")"

    for EFFECT in "${SHUFFLED[@]}"; do
        # Get effect-specific duration, or use default fallback
        DURATION="${EFFECT_DURATIONS[$EFFECT]:-$DEFAULT_EFFECT_DURATION}"

        if [[ "$FIRST_RUN" == true ]]; then
            # First effect: establish canvas position (no --reuse-canvas)
            timeout "$DURATION" tte \
                --canvas-width 0 \
                --canvas-height 0 \
                --anchor-canvas c \
                --anchor-text c \
                --no-eol \
                --no-restore-cursor \
                "$EFFECT" < "$ASCII_ART" 2>/dev/null &
            FIRST_RUN=false
        else
            # Subsequent effects: reuse canvas for seamless in-place transition
            timeout "$DURATION" tte \
                --canvas-width 0 \
                --canvas-height 0 \
                --anchor-canvas c \
                --anchor-text c \
                --reuse-canvas \
                --no-eol \
                --no-restore-cursor \
                "$EFFECT" < "$ASCII_ART" 2>/dev/null &
        fi
        TTE_PID=$!

        # Wait for tte to finish (or be killed by signal)
        wait "$TTE_PID" 2>/dev/null || true
        TTE_PID=""

        # Brief pause between effects
        sleep "$PAUSE_BETWEEN"
    done
done
